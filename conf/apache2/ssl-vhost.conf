# HTTPS Virtual Host Configuration
# This file defines the SSL/TLS virtual host

<IfModule mod_ssl.c>
    <VirtualHost *:443>
        # Server identification
        ServerAdmin webmaster@localhost
        ServerName localhost
        
        # Document root
        DocumentRoot /var/www/html
        
        # Directory configuration
        <Directory /var/www/html>
            Options Indexes FollowSymLinks MultiViews
            AllowOverride All
            Require all granted
            
            # Enable directory browsing if no index file
            DirectoryIndex index.php index.html index.htm
        </Directory>
        
        # Logging
        ErrorLog /var/log/lamp/apache-error.log
        CustomLog /var/log/lamp/apache-access.log combined
        
        # PHP-FPM default handler (can be overridden by .htaccess)
        <FilesMatch \.php$>
            SetHandler "proxy:fcgi://127.0.0.1:9083"
        </FilesMatch>
        
        # SSL Configuration
        SSLEngine on
        
        # SSL Certificate files (self-signed by default)
        SSLCertificateFile /etc/ssl/certs/apache-selfsigned.crt
        SSLCertificateKeyFile /etc/ssl/private/apache-selfsigned.key
        
        # SSL Protocol and Cipher Configuration
        # Disable weak protocols
        SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
        
        # Strong cipher suite
        SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
        SSLHonorCipherOrder off
        
        # Enable HTTP/2 if available
        Protocols h2 http/1.1
        
        # SSL Options
        <FilesMatch "\.(cgi|shtml|phtml|php)$">
            SSLOptions +StdEnvVars
        </FilesMatch>
        
        <Directory /usr/lib/cgi-bin>
            SSLOptions +StdEnvVars
        </Directory>
        
        # Deny access to sensitive files
        <FilesMatch "^\.">
            Require all denied
        </FilesMatch>
        
        # Deny access to backup and config files
        <FilesMatch "\.(bak|config|sql|fla|psd|ini|log|sh|inc|swp|dist)$">
            Require all denied
        </FilesMatch>
        
        # phpMyAdmin configuration
        Alias /phpmyadmin /var/www/html/phpmyadmin
        <Directory /var/www/html/phpmyadmin>
            Options FollowSymLinks
            DirectoryIndex index.php
            AllowOverride All
            Require all granted
        </Directory>
        
        # TinyFileManager configuration
        Alias /filemanager /var/www/html/filemanager
        <Directory /var/www/html/filemanager>
            Options FollowSymLinks
            DirectoryIndex index.php
            AllowOverride All
            Require all granted
        </Directory>
        
    </VirtualHost>
</IfModule>
